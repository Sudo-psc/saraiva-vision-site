###############################################################################
# MONITORAMENTO DA SARAIVA VISION API
# Aplicação Node.js/Express principal
# Porta: 3001
# PID atual: 2966947
# Caminho: /home/saraiva-vision-site/api/src/server.js
###############################################################################

check process saraiva-api matching "api/src/server.js"
    group nodejs
    group saraiva
    start program = "/usr/bin/systemctl start saraiva-api"
    stop program = "/usr/bin/systemctl stop saraiva-api"
    
    # Verificar se processo está rodando
    if not exist for 2 cycles then restart
    
    # Monitorar porta TCP 3001
    if failed host localhost port 3001 protocol http
        request "/health"
        with timeout 15 seconds
        for 2 cycles
    then restart
    
    # Monitorar uso de CPU (Node.js pode ser CPU-intensivo)
    if cpu > 85% for 5 cycles then alert
    if cpu > 95% for 10 cycles then restart
    
    # Monitorar uso de memória (detectar memory leaks)
    if totalmem > 1 GB for 3 cycles then alert
    if totalmem > 1.5 GB for 5 cycles then restart
    
    # Detectar memory leaks (crescimento contínuo)
    if memory usage > 60% for 10 cycles then alert
    if memory usage > 80% for 15 cycles then restart
    
    # Limitar tentativas de restart
    if 3 restarts within 5 cycles then timeout
    if 5 restarts within 15 cycles then unmonitor
    
    # Dependências (não reiniciar se nginx estiver down)
    depends on nginx

