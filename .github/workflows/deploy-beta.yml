name: 🚀 Deploy to Beta (Local Webhook)

on:
  push:
    branches:
      - develop
      - main
      - 'feature/**'
  pull_request:
    branches:
      - develop
      - main

env:
  NODE_VERSION: '22.x'
  ENVIRONMENT: beta

jobs:
  # ==============================================================================
  # Build & Test (Optional - pode ser removido para deploy mais rápido)
  # ==============================================================================
  build-and-test:
    name: 🔨 Build & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # Apenas em PRs

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: 🔍 Lint code
        run: npm run lint || true
        continue-on-error: true

      - name: 🧪 Run tests
        run: npm run test:comprehensive || true
        continue-on-error: true

      - name: 📊 Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-beta
          path: playwright-report/
          retention-days: 7

      - name: 🏗️ Build (test only)
        run: npm run build:vite

  # ==============================================================================
  # Notify Deploy (Push events trigger webhook on VPS)
  # ==============================================================================
  notify-deployment:
    name: 📢 Deployment Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: 📊 Deployment Info
        run: |
          echo "🚀 Deployment triggered for Beta environment"
          echo "📦 Branch: ${{ github.ref_name }}"
          echo "💾 Commit: ${{ github.sha }}"
          echo "👤 Author: ${{ github.actor }}"
          echo ""
          echo "ℹ️ Deployment is handled by VPS webhook receiver"
          echo "🔗 Webhook endpoint: https://saraivavision.com.br/webhook"
          echo ""
          echo "📝 The VPS webhook receiver will:"
          echo "  1. Pull latest code from GitHub"
          echo "  2. Run npm install"
          echo "  3. Build with npm run build:vite"
          echo "  4. Deploy to /var/www/saraivavision/beta"
          echo "  5. Run health checks"
          echo ""
          echo "✅ Check deployment logs on VPS: /home/saraiva-vision-site/logs/webhook.log"

      - name: 📋 Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'beta',
              description: 'Automatic deployment to beta via webhook',
              auto_merge: false,
              required_contexts: []
            });

  # ==============================================================================
  # PR Status Check
  # ==============================================================================
  pr-preview-info:
    name: 📝 PR Preview Info
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: 💬 Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## 🚀 Deployment Preview

            This PR will be automatically deployed to **Beta** environment when merged to \`${context.payload.pull_request.base.ref}\`.

            **Preview URL:** https://beta.saraivavision.com.br

            ### Deployment Details:
            - **Environment:** Beta (staging)
            - **Method:** Automatic via webhook
            - **Build:** Vite production build
            - **Deploy Path:** \`/var/www/saraivavision/beta\`

            ### After Merge:
            1. ✅ Webhook automatically triggered on VPS
            2. 🔨 Code pulled and built on server
            3. 🚀 Deployed to beta environment
            4. ✅ Health checks performed
            5. 📊 Logs available at \`/home/saraiva-vision-site/logs/webhook.log\`

            ---
            *Deployment is handled locally on VPS via webhook receiver*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
