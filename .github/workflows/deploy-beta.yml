name: ğŸš€ Deploy to Beta (Local Webhook)

on:
  push:
    branches:
      - develop
      - main
      - 'feature/**'
  pull_request:
    branches:
      - develop
      - main

env:
  NODE_VERSION: '22.x'
  ENVIRONMENT: beta

jobs:
  # ==============================================================================
  # Build & Test (Optional - pode ser removido para deploy mais rÃ¡pido)
  # ==============================================================================
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # Apenas em PRs

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸ” Lint code
        run: npm run lint || true
        continue-on-error: true

      - name: ğŸ§ª Run tests
        run: npm run test:comprehensive || true
        continue-on-error: true

      - name: ğŸ“Š Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-beta
          path: playwright-report/
          retention-days: 7

      - name: ğŸ—ï¸ Build (test only)
        run: npm run build:vite

  # ==============================================================================
  # Notify Deploy (Push events trigger webhook on VPS)
  # ==============================================================================
  notify-deployment:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“Š Deployment Info
        run: |
          echo "ğŸš€ Deployment triggered for Beta environment"
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ’¾ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "â„¹ï¸ Deployment is handled by VPS webhook receiver"
          echo "ğŸ”— Webhook endpoint: https://saraivavision.com.br/webhook"
          echo ""
          echo "ğŸ“ The VPS webhook receiver will:"
          echo "  1. Pull latest code from GitHub"
          echo "  2. Run npm install"
          echo "  3. Build with npm run build:vite"
          echo "  4. Deploy to /var/www/saraivavision/beta"
          echo "  5. Run health checks"
          echo ""
          echo "âœ… Check deployment logs on VPS: /home/saraiva-vision-site/logs/webhook.log"

      - name: ğŸ“‹ Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'beta',
              description: 'Automatic deployment to beta via webhook',
              auto_merge: false,
              required_contexts: []
            });

  # ==============================================================================
  # PR Status Check
  # ==============================================================================
  pr-preview-info:
    name: ğŸ“ PR Preview Info
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸš€ Deployment Preview

            This PR will be automatically deployed to **Beta** environment when merged to \`${context.payload.pull_request.base.ref}\`.

            **Preview URL:** https://beta.saraivavision.com.br

            ### Deployment Details:
            - **Environment:** Beta (staging)
            - **Method:** Automatic via webhook
            - **Build:** Vite production build
            - **Deploy Path:** \`/var/www/saraivavision/beta\`

            ### After Merge:
            1. âœ… Webhook automatically triggered on VPS
            2. ğŸ”¨ Code pulled and built on server
            3. ğŸš€ Deployed to beta environment
            4. âœ… Health checks performed
            5. ğŸ“Š Logs available at \`/home/saraiva-vision-site/logs/webhook.log\`

            ---
            *Deployment is handled locally on VPS via webhook receiver*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
