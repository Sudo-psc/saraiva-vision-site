###############################################################################
# MONITORAMENTO DO WEBHOOK RECEIVER
# Serviço para receber webhooks do GitHub (deployments)
# Porta: 9000 (localhost)
###############################################################################

check process webhook-receiver matching "webhook-receiver.cjs"
    group nodejs
    group deployment
    start program = "/usr/bin/systemctl start webhook-receiver"
    stop program = "/usr/bin/systemctl stop webhook-receiver"
    
    # Verificar se processo está rodando
    if not exist for 2 cycles then restart
    
    # Monitorar porta 9000 (apenas conectividade TCP, não HTTP)
    if failed host 127.0.0.1 port 9000
        with timeout 10 seconds
        for 3 cycles
    then restart
    
    # Monitorar uso de CPU
    if cpu > 60% for 5 cycles then alert
    if cpu > 85% for 10 cycles then restart
    
    # Monitorar uso de memória
    if totalmem > 200 MB for 3 cycles then alert
    if totalmem > 400 MB for 5 cycles then restart
    
    # Limitar tentativas de restart
    if 3 restarts within 5 cycles then timeout
    if 5 restarts within 15 cycles then unmonitor

