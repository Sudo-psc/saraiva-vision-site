location = /healthz {
    access_log /var/log/nginx/health.log health_json;
    default_type application/json;
    return 200 '{"status":"healthy","service":"nginx","timestamp":"$time_iso8601"}';
}

location = /nginx_status {
    stub_status on;
    allow 127.0.0.1;
    allow ::1;
    deny all;
}

location /.well-known/acme-challenge/ {
    root /var/www/letsencrypt;
    allow all;
    default_type text/plain;
}

location /api/ {
    limit_req zone=api_limit burst=60 nodelay;
    client_max_body_size 10m;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-Id $request_id;
    proxy_set_header Connection "";
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    proxy_buffering on;
    proxy_buffers 16 32k;
    proxy_busy_buffers_size 64k;
    proxy_max_temp_file_size 0;
    proxy_pass http://api_upstream;
    add_header Cache-Control "no-store" always;
}

location ^~ /cms/wp-admin/ {
    limit_req zone=login_limit burst=10 nodelay;
    include /etc/nginx/snippets/no-cache.conf;
    rewrite ^/cms/(.*)$ /$1 break;
    root /var/www/html;
    try_files $uri $uri/ /wp-admin/index.php?$args;
}

location = /cms/wp-login.php {
    limit_req zone=login_limit burst=5 nodelay;
    include /etc/nginx/snippets/no-cache.conf;
    rewrite ^/cms/(.*)$ /$1 break;
    include /etc/nginx/snippets/wordpress-fastcgi.conf;
}

location = /cms/xmlrpc.php {
    deny all;
    access_log off;
    log_not_found off;
}

location = /xmlrpc.php {
    return 444;
}

location ~* ^/cms/(.+\.php)$ {
    rewrite ^/cms/(.+)$ /$1 break;
    include /etc/nginx/snippets/wordpress-fastcgi.conf;
}

location ^~ /cms/wp-content/uploads/ {
    alias /var/www/html/wp-content/uploads/;
    access_log off;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
}

location ^~ /cms/wp-content/cache/ {
    alias /var/www/html/wp-content/cache/;
    access_log off;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
}

location ^~ /cms/ {
    rewrite ^/cms/(.*)$ /$1 break;
    root /var/www/html;
    index index.php index.html;
    try_files $uri $uri/ /index.php?$args;
}

location ^~ /wp-admin/ {
    return 301 /cms/wp-admin/$is_args$args;
}

location = /wp-login.php {
    return 301 /cms/wp-login.php$is_args$args;
}

location ~* ^/(wp-content|wp-includes)/.*\.php$ {
    return 404;
}

location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|webp|avif|woff2?|ttf|eot)$ {
    proxy_pass http://frontend_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-Id $request_id;
    proxy_cache frontend_cache;
    proxy_cache_valid 200 10m;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    add_header Cache-Control "public, max-age=604800, immutable" always;
    expires 7d;
}

location / {
    proxy_pass http://frontend_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header X-Request-Id $request_id;
    proxy_connect_timeout 5s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    proxy_cache frontend_cache;
    proxy_cache_bypass $http_upgrade $http_pragma;
    proxy_no_cache $http_upgrade $http_pragma;
    add_header Cache-Control "public, max-age=60" always;
}
