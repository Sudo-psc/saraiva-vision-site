###############################################################################
# MONITORAMENTO DO NGINX
# Servidor Web e Reverse Proxy
# Portas: 80 (HTTP) e 443 (HTTPS)
###############################################################################

check process nginx with pidfile /var/run/nginx.pid
    group www
    group nginx
    start program = "/usr/bin/systemctl start nginx"
    stop program = "/usr/bin/systemctl stop nginx"
    
    # Verificar se processo está rodando
    if not exist for 2 cycles then restart
    
    # Monitorar portas (apenas TCP, não HTTP content)
    if failed host localhost port 80 with timeout 10 seconds for 2 cycles then restart
    if failed host localhost port 443 with timeout 10 seconds for 2 cycles then restart
    
    # Monitorar uso de recursos
    if cpu > 80% for 3 cycles then alert
    if cpu > 95% for 5 cycles then restart
    if totalmem > 500 MB for 3 cycles then alert
    if totalmem > 800 MB for 5 cycles then restart
    
    # Verificar workers (normalmente 2-4 workers ativos)
    if children < 1 then alert
    if children > 10 for 3 cycles then alert
    
    # Auto-restart com limite de tentativas
    if 3 restarts within 5 cycles then timeout
    if 5 restarts within 10 cycles then unmonitor

