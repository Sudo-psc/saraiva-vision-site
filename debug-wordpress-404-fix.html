<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagn√≥stico API WordPress - Cl√≠nica Saraiva Vision</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
      }

      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      .clinic-header {
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      .clinic-header h1 {
        color: #667eea;
        margin: 0;
        font-size: 2.5em;
      }

      .clinic-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .test-section {
        margin: 30px 0;
        padding: 25px;
        border-left: 5px solid #667eea;
        background: #f8f9fa;
        border-radius: 0 10px 10px 0;
      }

      .test-title {
        font-size: 1.4em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status {
        padding: 8px 20px;
        border-radius: 25px;
        font-size: 0.9em;
        font-weight: bold;
        margin-left: 10px;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status.testing {
        background: #e2e3e5;
        color: #495057;
      }

      .result {
        margin: 15px 0;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #ddd;
      }

      .result.success {
        border-left-color: #28a745;
      }
      .result.error {
        border-left-color: #dc3545;
      }
      .result.warning {
        border-left-color: #ffc107;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        margin: 8px;
        transition: all 0.3s ease;
      }

      button:hover:not(:disabled) {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .url-test {
        margin: 10px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #6c757d;
      }

      .url-test.success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      .url-test.error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }

      .recommendations {
        background: #e7f3ff;
        border: 2px solid #b3d7ff;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
      }

      .recommendations h4 {
        margin-top: 0;
        color: #0066cc;
      }

      .code-block {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 0.9em;
        overflow-x: auto;
        white-space: pre;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
        .clinic-info {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="clinic-header">
        <h1>üè• Diagn√≥stico WordPress API</h1>
        <h2>Cl√≠nica Saraiva Vision</h2>
        <p>
          <strong>Dr. Philipe Saraiva Cruz</strong> - CRM-MG 69.870 |
          <strong>Ana L√∫cia</strong> - Enfermeira
        </p>
        <p>üìç Caratinga, MG | ü§ù Parceria: Cl√≠nica Amor e Sa√∫de</p>
      </div>

      <div class="clinic-info">
        <div>
          <h4>ü©∫ Servi√ßos Oferecidos</h4>
          <ul>
            <li>Consultas Oftalmol√≥gicas</li>
            <li>Refra√ß√£o e Biometria</li>
            <li>Paquimetria</li>
            <li>Mapeamento de Retina</li>
            <li>Retinografia</li>
          </ul>
        </div>
        <div>
          <h4>üî¨ Exames Especializados</h4>
          <ul>
            <li>Topografia Corneana</li>
            <li>Meiobografia</li>
            <li>Testes de Jones e Schirmer</li>
            <li>Adapta√ß√£o de Lentes de Contato</li>
          </ul>
        </div>
      </div>

      <div class="test-section">
        <div class="test-title">üîß Controles de Diagn√≥stico</div>
        <button onclick="runFullDiagnosis()">üöÄ Diagn√≥stico Completo</button>
        <button onclick="testApiUrls()">üì° Testar URLs da API</button>
        <button onclick="checkPermalinks()">üîó Verificar Permalinks</button>
        <button onclick="testFallbacks()">üõ°Ô∏è Testar Fallbacks</button>
        <button onclick="clearResults()">üßπ Limpar</button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      // Configura√ß√µes da Cl√≠nica Saraiva Vision
      const clinicConfig = {
        name: "Cl√≠nica Saraiva Vision",
        location: "Caratinga, MG",
        doctor: "Dr. Philipe Saraiva Cruz (CRM-MG 69.870)",
        nurse: "Ana L√∫cia",
        partnership: "Cl√≠nica Amor e Sa√∫de",

        // URLs para teste
        urls: {
          production: "https://clinicasaraivavision.com.br",
          development: "http://localhost:8081",
          staging: "https://staging.clinicasaraivavision.com.br",
        },
      };

      let testResults = {};

      function addResult(testName, status, message, details = null) {
        testResults[testName] = {
          status,
          message,
          details,
          timestamp: new Date().toISOString(),
        };
        displayResults();
      }

      function displayResults() {
        const container = document.getElementById("results");
        let html = "";

        Object.keys(testResults).forEach((testName) => {
          const result = testResults[testName];
          const statusClass = result.status;
          const icon =
            {
              success: "‚úÖ",
              error: "‚ùå",
              warning: "‚ö†Ô∏è",
              info: "‚ÑπÔ∏è",
              testing: "üîÑ",
            }[result.status] || "üìã";

          html += `
                    <div class="test-section">
                        <div class="test-title">
                            ${icon} ${testName}
                            <span class="status ${statusClass}">${result.status.toUpperCase()}</span>
                        </div>
                        <div class="result ${statusClass}">
                            <strong>Resultado:</strong> ${result.message}
                        </div>
                        ${result.details ? renderDetails(result.details) : ""}
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      function renderDetails(details) {
        if (typeof details === "string") {
          return `<div class="code-block">${details}</div>`;
        }

        if (Array.isArray(details)) {
          return `
                    <div class="recommendations">
                        <h4>üìã Detalhes:</h4>
                        <ul>${details
                          .map((item) => `<li>${item}</li>`)
                          .join("")}</ul>
                    </div>
                `;
        }

        return `<div class="code-block">${JSON.stringify(
          details,
          null,
          2
        )}</div>`;
      }

      async function testApiUrls() {
        addResult(
          "Teste de URLs",
          "testing",
          "Testando m√∫ltiplas configura√ß√µes de API...",
          { loading: true }
        );

        const results = [];

        // URLs para testar
        const urlsToTest = [
          {
            name: "Produ√ß√£o - REST API Padr√£o",
            url: `${clinicConfig.urls.production}/wp-json/wp/v2/posts?per_page=1`,
          },
          {
            name: "Produ√ß√£o - Fallback rest_route",
            url: `${clinicConfig.urls.production}/?rest_route=/wp/v2/posts&per_page=1`,
          },
          {
            name: "Produ√ß√£o - Fallback index.php",
            url: `${clinicConfig.urls.production}/index.php?rest_route=/wp/v2/posts&per_page=1`,
          },
          {
            name: "Desenvolvimento - Mock Server",
            url: `${clinicConfig.urls.development}/wp-json/wp/v2/posts?per_page=1`,
          },
        ];

        for (const testUrl of urlsToTest) {
          // Configurable timeout (default 8 seconds)
          const timeoutMs = 8000;
          let controller;
          let timeoutId;
          try {
            console.log(`üîç Testando: ${testUrl.name}`);
            controller = new AbortController();
            timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            const response = await fetch(testUrl.url, {
              method: "GET",
              headers: {
                Accept: "application/json"
              },
              signal: controller.signal,
            });

            const responseText = await response.text();
            const testResult = {
              name: testUrl.name,
              url: testUrl.url,
              status: response.status,
              ok: response.ok,
              isJson: false,
              isHtml:
                /<html/i.test(responseText) ||
                /<!doctype/i.test(responseText),
              responsePreview: responseText.substring(0, 200),
            };

            if (response.ok) {
              try {
                const data = JSON.parse(responseText);
                testResult.isJson = true;
                testResult.itemsFound = Array.isArray(data) ? data.length : 1;
                testResult.success = true;
              } catch (jsonError) {
                testResult.jsonError = jsonError.message;
                testResult.success = false;
              }
            }

            results.push(testResult);
          } catch (error) {
            // Handle timeout/abort errors specifically
            const isTimeout = error.name === "AbortError";
            results.push({
              name: testUrl.name,
              url: testUrl.url,
              error: isTimeout
                ? `Timeout ap√≥s ${timeoutMs / 1000}s - servidor pode estar lento ou inativo`
                : error.message,
              isTimeout: isTimeout,
              success: false,
            });
          } finally {
            if (timeoutId) clearTimeout(timeoutId);
          }
        }

        // Analisar resultados
        const workingUrls = results.filter((r) => r.success);
        const failedUrls = results.filter((r) => !r.success);

        if (workingUrls.length > 0) {
          addResult(
            "Teste de URLs",
            "success",
            `${workingUrls.length} URL(s) funcionando corretamente`,
            {
              working: workingUrls,
              failed: failedUrls,
              recommendations:
                workingUrls.length < results.length
                  ? [
                      "Algumas URLs falharam - verificar configura√ß√£o de servidor",
                      "Priorizar URL funcionais para produ√ß√£o",
                    ]
                  : ["Todas as URLs testadas est√£o funcionando!"],
            }
          );
        } else {
          addResult(
            "Teste de URLs",
            "error",
            "Nenhuma URL da API est√° funcionando",
            {
              allFailed: results,
              possibleCauses: [
                "üîß WordPress n√£o instalado ou inativo",
                "üö´ API REST desabilitada por plugin",
                "‚öôÔ∏è Problema de configura√ß√£o do servidor",
                "üåê Problema de conectividade",
                "üìù Permalinks mal configurados",
              ],
              nextSteps: [
                "1. Verificar se WordPress est√° instalado",
                "2. Verificar plugins ativos",
                "3. Testar acesso ao painel administrativo",
                "4. Verificar logs do servidor",
              ],
            }
          );
        }
      }

      async function checkPermalinks() {
        addResult(
          "Verifica√ß√£o de Permalinks",
          "testing",
          "Verificando estrutura de URLs..."
        );

        try {
          // Testar estrutura de permalinks
          const tests = [
            {
              name: "Teste de Homepage",
              url: clinicConfig.urls.production,
              expected: "HTML da homepage",
            },
            {
              name: "Teste wp-admin (deve dar 302 para login)",
              url: `${clinicConfig.urls.production}/wp-admin/`,
              expected: "Redirect ou p√°gina de login",
            },
            {
              name: "Teste wp-json discovery",
              url: `${clinicConfig.urls.production}/wp-json/`,
              expected: "JSON com informa√ß√µes da API",
            },
          ];

          const results = [];

          for (const test of tests) {
            try {
              const response = await fetch(test.url);
              results.push({
                name: test.name,
                url: test.url,
                status: response.status,
                ok: response.ok || response.status === 302, // 302 √© ok para wp-admin
                contentType: response.headers.get("content-type"),
              });
            } catch (error) {
              results.push({
                name: test.name,
                url: test.url,
                error: error.message,
              });
            }
          }

          const workingTests = results.filter((r) => r.ok);

          if (workingTests.length === tests.length) {
            addResult(
              "Verifica√ß√£o de Permalinks",
              "success",
              "Estrutura de permalinks parece estar funcionando",
              { tests: results }
            );
          } else {
            addResult(
              "Verifica√ß√£o de Permalinks",
              "warning",
              "Alguns testes de permalink falharam",
              {
                tests: results,
                recommendations: [
                  "Verificar configura√ß√£o de permalinks no wp-admin",
                  "Verificar arquivo .htaccess",
                  "Verificar se mod_rewrite est√° habilitado",
                ],
              }
            );
          }
        } catch (error) {
          addResult(
            "Verifica√ß√£o de Permalinks",
            "error",
            `Erro durante teste: ${error.message}`
          );
        }
      }

      async function testFallbacks() {
        addResult(
          "Teste de Fallbacks",
          "info",
          "Sistema de fallback da cl√≠nica sempre ativo"
        );

        // Dados de fallback da Cl√≠nica Saraiva Vision
        const fallbackData = {
          posts: [
            {
              title: "A Import√¢ncia do Exame de Fundo de Olho",
              slug: "importancia-exame-fundo-de-olho",
              author: "Dr. Philipe Saraiva Cruz",
            },
            {
              title: "Cirurgia Refrativa a Laser: Tecnologia e Seguran√ßa",
              slug: "cirurgia-refrativa-laser",
              author: "Dr. Philipe Saraiva Cruz",
            },
            {
              title: "Cuidados Essenciais com Lentes de Contato",
              slug: "cuidados-lentes-contato",
              author: "Ana L√∫cia",
            },
          ],
          categories: [
            "Consultas Oftalmol√≥gicas",
            "Exames Especializados",
            "Refra√ß√£o",
            "Mapeamento de Retina",
            "Lentes de Contato",
          ],
        };

        addResult(
          "Teste de Fallbacks",
          "success",
          "Sistema de fallback configurado e funcionando",
          {
            postsAvailable: fallbackData.posts.length,
            categoriesAvailable: fallbackData.categories.length,
            guarantee: "Site nunca ficar√° sem conte√∫do m√©dico",
            content: fallbackData,
          }
        );
      }

      async function runFullDiagnosis() {
        clearResults();

        addResult(
          "Iniciando Diagn√≥stico Completo",
          "info",
          "Executando todos os testes para a Cl√≠nica Saraiva Vision..."
        );

        // Executar todos os testes sequencialmente
        await testApiUrls();
        await checkPermalinks();
        await testFallbacks();

        addResult(
          "Diagn√≥stico Finalizado",
          "success",
          "Todos os testes foram executados. Verifique os resultados acima.",
          {
            timestamp: new Date().toISOString(),
            clinic: clinicConfig.name,
            location: clinicConfig.location,
          }
        );
      }

      function clearResults() {
        testResults = {};
        document.getElementById("results").innerHTML = "";
      }

      // Executar teste inicial ao carregar
      window.addEventListener("load", () => {
        addResult(
          "Sistema Carregado",
          "info",
          "Diagn√≥stico pronto para a Cl√≠nica Saraiva Vision",
          {
            clinic: clinicConfig.name,
            doctor: clinicConfig.doctor,
            nurse: clinicConfig.nurse,
            ready: true,
          }
        );
      });
    </script>
  </body>
</html>
