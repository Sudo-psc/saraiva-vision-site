# ============================================================
# Nginx Patch para Agendamento Nin Saúde
# Adicionar ao arquivo /etc/nginx/sites-available/saraivavision
# ============================================================

# IMPORTANTE: Atualizar a diretiva Content-Security-Policy-Report-Only
# para incluir https://apolo.ninsaude.com no frame-src

# Linha atual:
# frame-src 'self' https://www.google.com https://open.spotify.com https://*.spotify.com;

# Nova linha (com Nin Saúde):
# frame-src 'self' https://www.google.com https://open.spotify.com https://*.spotify.com https://apolo.ninsaude.com https://*.ninsaude.com;

# ============================================================
# Comandos para aplicar o patch:
# ============================================================

# 1. Backup do arquivo atual
sudo cp /etc/nginx/sites-available/saraivavision /etc/nginx/sites-available/saraivavision.backup.$(date +%Y%m%d_%H%M%S)

# 2. Aplicar o patch
sudo sed -i 's|frame-src '\''self'\'' https://www.google.com https://open.spotify.com https://\*\.spotify\.com|frame-src '\''self'\'' https://www.google.com https://open.spotify.com https://*.spotify.com https://apolo.ninsaude.com https://*.ninsaude.com|g' /etc/nginx/sites-available/saraivavision

# 3. Testar configuração
sudo nginx -t

# 4. Recarregar nginx (se teste passou)
sudo systemctl reload nginx

# ============================================================
# Verificação
# ============================================================

# Verificar se o patch foi aplicado corretamente:
grep "frame-src" /etc/nginx/sites-available/saraivavision | grep ninsaude

# Deverá mostrar:
# frame-src 'self' https://www.google.com https://open.spotify.com https://*.spotify.com https://apolo.ninsaude.com https://*.ninsaude.com;

# ============================================================
# Alternativa: Adicionar location específica para /agendamento
# ============================================================
# Se preferir ter configuração específica para a rota de agendamento:

location = /agendamento {
    # Permitir iframe da Nin Saúde especificamente nesta rota
    add_header Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.gstatic.com https://cdn.pulse.is; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data:; connect-src 'self' https://saraivavision.com.br https://*.supabase.co wss://*.supabase.co https://lc.pulse.is https://maps.googleapis.com https://apolo.ninsaude.com https://*.ninsaude.com; frame-src 'self' https://www.google.com https://open.spotify.com https://*.spotify.com https://apolo.ninsaude.com https://*.ninsaude.com; object-src 'none'; base-uri 'self'; form-action 'self';" always;
    
    try_files $uri $uri/ /index.html;
}

# ============================================================
# Notas Importantes
# ============================================================

# 1. CSP está em modo Report-Only (não bloqueia, apenas reporta)
#    Para ativar proteção real, mude de:
#    Content-Security-Policy-Report-Only
#    Para:
#    Content-Security-Policy

# 2. O domínio *.ninsaude.com permite todos os subdomínios
#    Se preferir mais restrição, use apenas:
#    https://apolo.ninsaude.com

# 3. Também adicionamos ninsaude.com ao connect-src para permitir
#    requisições AJAX/fetch para o sistema Nin

# 4. Sempre teste após mudanças:
#    sudo nginx -t && sudo systemctl reload nginx

# ============================================================
# Rollback (em caso de problemas)
# ============================================================

# Restaurar backup:
# sudo cp /etc/nginx/sites-available/saraivavision.backup.TIMESTAMP /etc/nginx/sites-available/saraivavision
# sudo nginx -t && sudo systemctl reload nginx
