# ============================================================
# Google Tag Manager & Analytics Reverse Proxy
# ============================================================
# Torna GTM/GA4 resistente a ad blockers ao usar domínio próprio
# Ad blockers não detectam porque não usa URLs do Google
#
# Uso:
# - GTM: <script src="https://saraivavision.com.br/t/gtm.js?id=GTM-KF2NP85D">
# - GA4: <script src="https://saraivavision.com.br/t/gtag.js?id=G-LXWRK8ELS6">
#
# @author Dr. Philipe Saraiva Cruz
# ============================================================

# Proxy para Google Tag Manager Script (gtm.js)
location /t/gtm.js {
    # Rewrite para preservar query string
    rewrite ^/t/gtm\.js$ /gtm.js break;

    # Proxy para GTM
    proxy_pass https://www.googletagmanager.com;

    # Headers de proxy
    proxy_set_header Host www.googletagmanager.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache agressivo para performance
    proxy_cache_valid 200 1h;
    proxy_cache_bypass $http_pragma $http_authorization;
    add_header X-Cache-Status $upstream_cache_status;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Cache-Control "public, max-age=3600";

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}

# Proxy para Google Analytics/Tag Script (gtag.js)
location /t/gtag.js {
    # Rewrite para preservar query string
    rewrite ^/t/gtag\.js$ /gtag/js break;

    # Proxy para Google Analytics
    proxy_pass https://www.googletagmanager.com;

    # Headers de proxy
    proxy_set_header Host www.googletagmanager.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache agressivo
    proxy_cache_valid 200 1h;
    proxy_cache_bypass $http_pragma $http_authorization;
    add_header X-Cache-Status $upstream_cache_status;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Cache-Control "public, max-age=3600";

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}

# Proxy para GA4 Events Collection (/g/collect)
location /t/collect {
    # Rewrite para preservar query string
    rewrite ^/t/collect$ /g/collect break;

    # Proxy para Google Analytics collection
    proxy_pass https://www.google-analytics.com;

    # Headers de proxy - CRÍTICO para preservar IP do cliente
    proxy_set_header Host www.google-analytics.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Referer $http_referer;

    # Preserve cookies
    proxy_pass_request_headers on;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;

    # Handle OPTIONS (CORS preflight)
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
        add_header Access-Control-Max-Age 86400;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;

    # Timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 5s;
    proxy_read_timeout 5s;
}

# Proxy para CCM (Consent Mode) - resolve o ERR_FAILED
location /t/ccm/collect {
    # Rewrite para preservar query string
    rewrite ^/t/ccm/collect$ /ccm/collect break;

    # Proxy para Google Consent Mode
    proxy_pass https://www.google.com;

    # Headers de proxy
    proxy_set_header Host www.google.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent $http_user_agent;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}
