###############################################################################
# MONITORAMENTO DO SSH (CRÍTICO)
# Acesso remoto ao servidor
# Porta: 22
# ATENÇÃO: Se SSH cair, você perde acesso ao servidor!
###############################################################################

check process sshd with pidfile /var/run/sshd.pid
    group system
    group ssh
    start program = "/usr/bin/systemctl start ssh"
    stop program = "/usr/bin/systemctl stop ssh"
    
    # Verificar se processo está rodando
    if not exist for 2 cycles then restart
    
    # Monitorar porta 22 (SSH protocol)
    if failed host localhost port 22 protocol ssh
        with timeout 15 seconds
        for 3 cycles
    then restart
    
    # Monitorar uso de CPU (SSH deve ser leve)
    if cpu > 50% for 5 cycles then alert
    if cpu > 80% for 10 cycles then alert
    
    # Monitorar uso de memória (ajustado para 250MB baseline)
    if totalmem > 300 MB for 5 cycles then alert
    if totalmem > 500 MB for 10 cycles then alert
    
    # Verificar número de conexões ativas
    if children > 50 for 5 cycles then alert
    if children > 100 then alert
    
    # Limitar tentativas de restart (mais tolerante para SSH)
    if 5 restarts within 10 cycles then timeout

