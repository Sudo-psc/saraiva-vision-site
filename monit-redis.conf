###############################################################################
# MONITORAMENTO DO REDIS
# Cache e banco de dados NoSQL em memória
# Porta: 6379 (localhost only)
# PID atual: 1363169
###############################################################################

check process redis-server with pidfile /var/run/redis/redis-server.pid
    group database
    group redis
    start program = "/usr/bin/systemctl start redis-server"
    stop program = "/usr/bin/systemctl stop redis-server"
    
    # Verificar se processo está rodando
    if not exist for 2 cycles then restart
    
    # Monitorar porta 6379 (conexão TCP básica)
    if failed host 127.0.0.1 port 6379 protocol redis
        with timeout 10 seconds
        for 2 cycles
    then restart
    
    # Monitorar uso de CPU (Redis deve ser leve)
    if cpu > 70% for 5 cycles then alert
    if cpu > 90% for 10 cycles then restart
    
    # Monitorar uso de memória (Redis armazena tudo em RAM)
    if totalmem > 500 MB for 3 cycles then alert
    if totalmem > 1 GB for 5 cycles then alert
    
    # Detectar possível memory leak
    if memory usage > 40% for 10 cycles then alert
    if memory usage > 60% for 15 cycles then restart
    
    # Limitar tentativas de restart
    if 3 restarts within 5 cycles then timeout
    if 5 restarts within 15 cycles then unmonitor

