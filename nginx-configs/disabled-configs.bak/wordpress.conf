# WordPress PHP-FPM Configuration for Cl√≠nica Saraiva Vision
# Dr. Philipe Saraiva Cruz - CRM-MG 69.870
# Caratinga, Minas Gerais

server {
    listen 8083;
    server_name localhost;

    # Security headers for medical clinic data
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # WordPress REST API endpoints
    location /wp-json/ {
        try_files $uri @wordpress;

        # CORS for medical API integration
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

        # Cache control for API responses
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # WordPress admin area - NO CACHING for security
    location /wp-admin/ {
        try_files $uri @wordpress;

        # Security for admin area
        add_header Cache-Control "no-cache, no-store, must-revalidate, private" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # WordPress login - NO CACHING for security
    location /wp-login.php {
        try_files $uri @wordpress;

        add_header Cache-Control "no-cache, no-store, must-revalidate, private" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # WordPress PHP files
    location ~ \.php$ {
        try_files $uri @wordpress;

        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        include fastcgi_params;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # Security parameters
        fastcgi_param HTTPS off;
        fastcgi_param HTTP_HOST $host;
        fastcgi_param SERVER_NAME $host;
        fastcgi_param SERVER_PORT $server_port;

        # WordPress specific parameters
        fastcgi_param WP_ENVIRONMENT_TYPE development;

        # Timeout settings for medical content
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Static files with proper caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        try_files $uri @wordpress;
    }

    # Fallback to WordPress
    location @wordpress {
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        include fastcgi_params;

        fastcgi_param HTTPS off;
        fastcgi_param HTTP_HOST $host;
        fastcgi_param SERVER_NAME $host;
        fastcgi_param SERVER_PORT $server_port;
    }

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type application/json;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";

        return 200 '{"status":"healthy","service":"wordpress","server":"Saraiva Vision WordPress","version":"6.4","environment":"development","checks":{"fpm":"running","database":"connected","api":"enabled"},"endpoints":{"health":"/health","api":"/wp-json/*","admin":"/wp-admin/*"}}';
    }

    # Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Block access to wp-config.php and other sensitive files
    location ~* /(wp-config\.php|xmlrpc\.php|wp-load\.php) {
        deny all;
        access_log off;
        log_not_found off;
    }
}