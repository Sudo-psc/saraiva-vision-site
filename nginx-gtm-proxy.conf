# ============================================================
# Google Tag Manager & Analytics Reverse Proxy
# ============================================================
# ⚠️ COMPLIANCE REQUIREMENTS (GDPR/LGPD):
#
# This proxy configuration MUST only be enabled with proper user consent.
# Before activating this proxy in production:
#
# 1. ✅ REQUIRED: Implement consent management system
#    - Must obtain explicit user consent before loading analytics
#    - Consent banner must be compliant with GDPR/LGPD
#    - Users must be able to opt-out at any time
#
# 2. ✅ REQUIRED: Privacy Policy Updates
#    - Disclose use of Google Analytics and Tag Manager
#    - Explain data collection and processing
#    - Provide contact information for data protection officer
#    - Link: https://saraivavision.com.br/privacidade
#
# 3. ✅ REQUIRED: Server-Side Consent Validation
#    - Check for consent cookie/flag before proxying requests
#    - Return 403 Forbidden if consent not granted
#    - Example: if ($cookie_analytics_consent != "granted") { return 403; }
#
# 4. ✅ REQUIRED: Legal Review
#    - Consult with privacy counsel before production deployment
#    - Ensure compliance with LGPD (Brazil) and GDPR (EU)
#    - Document consent flow and data processing agreements
#
# 5. ⚠️ ETHICAL CONSIDERATIONS:
#    - This proxy bypasses ad blockers which may violate user preferences
#    - Always respect user choice and provide clear opt-out mechanisms
#    - Consider implementing Consent Mode v2 for better privacy
#
# Uso (apenas após implementar consent):
# - GTM: <script src="https://saraivavision.com.br/t/gtm.js?id=GTM-KF2NP85D">
# - GA4: <script src="https://saraivavision.com.br/t/gtag.js?id=G-LXWRK8ELS6">
#
# @author Dr. Philipe Saraiva Cruz
# @license Requires consent management implementation
# ============================================================

# ============================================================
# Proxy Cache Configuration for Analytics
# ============================================================
# Define cache zone for GTM/Analytics proxy responses
proxy_cache_path /var/cache/nginx/gtm_cache
    levels=1:2
    keys_zone=gtm_cache:10m
    max_size=50m
    inactive=1h
    use_temp_path=off;

# Proxy para Google Tag Manager Script (gtm.js)
location = /t/gtm.js {
    # ⚠️ CONSENT CHECK: Uncomment when consent system is implemented
    # if ($cookie_analytics_consent != "granted") {
    #     return 403;
    # }

    # Proxy para GTM
    proxy_pass https://www.googletagmanager.com/gtm.js$is_args$args;

    # Headers de proxy
    proxy_set_header Host www.googletagmanager.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache configuration
    proxy_cache gtm_cache;
    proxy_cache_valid 200 1h;
    proxy_cache_bypass $http_pragma $http_authorization;
    proxy_cache_key "$scheme$proxy_host$request_uri";
    add_header X-Cache-Status $upstream_cache_status;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Cache-Control "public, max-age=3600";

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}

# Proxy para Google Analytics/Tag Script (gtag.js)
location ~ ^/t/gtag\.js$ {
    # ⚠️ CONSENT CHECK: Uncomment when consent system is implemented
    # if ($cookie_analytics_consent != "granted") {
    #     return 403;
    # }

    # Proxy para Google Analytics
    proxy_pass https://www.googletagmanager.com/gtag/js$is_args$args;

    # Headers de proxy
    proxy_set_header Host www.googletagmanager.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache configuration
    proxy_cache gtm_cache;
    proxy_cache_valid 200 1h;
    proxy_cache_bypass $http_pragma $http_authorization;
    proxy_cache_key "$scheme$proxy_host$request_uri";
    add_header X-Cache-Status $upstream_cache_status;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Cache-Control "public, max-age=3600";

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}

# Proxy para GA4 Events Collection (/g/collect)
location ~ ^/t/collect$ {
    # ⚠️ CRITICAL: CONSENT CHECK - This endpoint collects user data
    # Uncomment when consent system is implemented
    # if ($cookie_analytics_consent != "granted") {
    #     return 403;
    # }

    # Proxy para Google Analytics collection
    proxy_pass https://www.google-analytics.com/g/collect$is_args$args;

    # Headers de proxy - CRÍTICO para preservar IP do cliente
    proxy_set_header Host www.google-analytics.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Referer $http_referer;

    # Preserve cookies
    proxy_pass_request_headers on;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;

    # Handle OPTIONS (CORS preflight)
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
        add_header Access-Control-Max-Age 86400;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;

    # Timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 5s;
    proxy_read_timeout 5s;
}

# Proxy para GTM DataLayer (analytics.js - Universal Analytics legacy)
location ~ ^/t/analytics\.js$ {
    # ⚠️ CONSENT CHECK: Uncomment when consent system is implemented
    # if ($cookie_analytics_consent != "granted") {
    #     return 403;
    # }

    # Proxy para Google Analytics legacy
    proxy_pass https://www.google-analytics.com/analytics.js;

    # Headers de proxy
    proxy_set_header Host www.google-analytics.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache configuration
    proxy_cache gtm_cache;
    proxy_cache_valid 200 1h;
    proxy_cache_key "$scheme$proxy_host$request_uri";
    add_header X-Cache-Status $upstream_cache_status;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Cache-Control "public, max-age=3600";

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}

# Proxy para CCM (Consent Mode) - resolve o ERR_FAILED
location ~ ^/t/ccm/collect$ {
    # ⚠️ NOTE: This endpoint sends consent signals to Google
    # May still need consent check depending on privacy requirements
    # if ($cookie_analytics_consent != "granted") {
    #     return 403;
    # }

    # Proxy para Google Consent Mode
    proxy_pass https://www.google.com/ccm/collect$is_args$args;

    # Headers de proxy
    proxy_set_header Host www.google.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent $http_user_agent;

    # Headers de resposta
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;

    # SSL
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
}
