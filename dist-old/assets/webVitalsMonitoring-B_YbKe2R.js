let D=-1;const m=n=>{addEventListener("pageshow",(t=>{t.persisted&&(D=t.timeStamp,n(t))}),!0)},u=(n,t,r,e)=>{let i,o;return a=>{t.value>=0&&(a||e)&&(o=t.value-(i??0),(o||i===void 0)&&(i=t.value,t.delta=o,t.rating=((s,l)=>s>l[1]?"poor":s>l[0]?"needs-improvement":"good")(t.value,r),n(t)))}},L=n=>{requestAnimationFrame((()=>requestAnimationFrame((()=>n()))))},I=()=>{const n=performance.getEntriesByType("navigation")[0];if(n&&n.responseStart>0&&n.responseStart<performance.now())return n},f=()=>I()?.activationStart??0,c=(n,t=-1)=>{const r=I();let e="navigate";return D>=0?e="back-forward-cache":r&&(document.prerendering||f()>0?e="prerender":document.wasDiscarded?e="restore":r.type&&(e=r.type.replace(/_/g,"-"))),{name:n,value:t,rating:"good",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:e}},w=new WeakMap;function E(n,t){return w.get(n)||w.set(n,new t),w.get(n)}class q{t;i=0;o=[];h(t){if(t.hadRecentInput)return;const r=this.o[0],e=this.o.at(-1);this.i&&r&&e&&t.startTime-e.startTime<1e3&&t.startTime-r.startTime<5e3?(this.i+=t.value,this.o.push(t)):(this.i=t.value,this.o=[t]),this.t?.(t)}}const v=(n,t,r={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(n)){const e=new PerformanceObserver((i=>{Promise.resolve().then((()=>{t(i.getEntries())}))}));return e.observe({type:n,buffered:!0,...r}),e}}catch{}},M=n=>{let t=!1;return()=>{t||(n(),t=!0)}};let g=-1;const V=new Set,F=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,C=n=>{if(document.visibilityState==="hidden"){if(n.type==="visibilitychange")for(const t of V)t();isFinite(g)||(g=n.type==="visibilitychange"?n.timeStamp:0,removeEventListener("prerenderingchange",C,!0))}},T=()=>{if(g<0){const n=f();g=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((r=>r.name==="hidden"&&r.startTime>n))[0]?.startTime)??F(),addEventListener("visibilitychange",C,!0),addEventListener("prerenderingchange",C,!0),m((()=>{setTimeout((()=>{g=F()}))}))}return{get firstHiddenTime(){return g},onHidden(n){V.add(n)}}},b=n=>{document.prerendering?addEventListener("prerenderingchange",(()=>n()),!0):n()},$=[1800,3e3],_=(n,t={})=>{b((()=>{const r=T();let e,i=c("FCP");const o=v("paint",(a=>{for(const s of a)s.name==="first-contentful-paint"&&(o.disconnect(),s.startTime<r.firstHiddenTime&&(i.value=Math.max(s.startTime-f(),0),i.entries.push(s),e(!0)))}));o&&(e=u(n,i,$,t.reportAllChanges),m((a=>{i=c("FCP"),e=u(n,i,$,t.reportAllChanges),L((()=>{i.value=performance.now()-a.timeStamp,e(!0)}))})))}))},k=[.1,.25],j=(n,t={})=>{const r=T();_(M((()=>{let e,i=c("CLS",0);const o=E(t,q),a=l=>{for(const d of l)o.h(d);o.i>i.value&&(i.value=o.i,i.entries=o.o,e())},s=v("layout-shift",a);s&&(e=u(n,i,k,t.reportAllChanges),r.onHidden((()=>{a(s.takeRecords()),e(!0)})),m((()=>{o.i=0,i=c("CLS",0),e=u(n,i,k,t.reportAllChanges),L((()=>e()))})),setTimeout(e))})))};let H=0,P=1/0,y=0;const J=n=>{for(const t of n)t.interactionId&&(P=Math.min(P,t.interactionId),y=Math.max(y,t.interactionId),H=y?(y-P)/7+1:0)};let S;const R=()=>S?H:performance.interactionCount??0,z=()=>{"interactionCount"in performance||S||(S=v("event",J,{type:"event",buffered:!0,durationThreshold:0}))};let N=0;class G{u=[];l=new Map;m;p;v(){N=R(),this.u.length=0,this.l.clear()}L(){const t=Math.min(this.u.length-1,Math.floor((R()-N)/50));return this.u[t]}h(t){if(this.m?.(t),!t.interactionId&&t.entryType!=="first-input")return;const r=this.u.at(-1);let e=this.l.get(t.interactionId);if(e||this.u.length<10||t.duration>r.P){if(e?t.duration>e.P?(e.entries=[t],e.P=t.duration):t.duration===e.P&&t.startTime===e.entries[0].startTime&&e.entries.push(t):(e={id:t.interactionId,entries:[t],P:t.duration},this.l.set(e.id,e),this.u.push(e)),this.u.sort(((i,o)=>o.P-i.P)),this.u.length>10){const i=this.u.splice(10);for(const o of i)this.l.delete(o.id)}this.p?.(e)}}}const x=n=>{const t=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?n():(n=M(n),addEventListener("visibilitychange",n,{once:!0,capture:!0}),t((()=>{n(),removeEventListener("visibilitychange",n,{capture:!0})})))},O=[200,500],K=(n,t={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;const r=T();b((()=>{z();let e,i=c("INP");const o=E(t,G),a=l=>{x((()=>{for(const p of l)o.h(p);const d=o.L();d&&d.P!==i.value&&(i.value=d.P,i.entries=d.entries,e())}))},s=v("event",a,{durationThreshold:t.durationThreshold??40});e=u(n,i,O,t.reportAllChanges),s&&(s.observe({type:"first-input",buffered:!0}),r.onHidden((()=>{a(s.takeRecords()),e(!0)})),m((()=>{o.v(),i=c("INP"),e=u(n,i,O,t.reportAllChanges)})))}))};class Q{m;h(t){this.m?.(t)}}const W=[2500,4e3],U=(n,t={})=>{b((()=>{const r=T();let e,i=c("LCP");const o=E(t,Q),a=l=>{t.reportAllChanges||(l=l.slice(-1));for(const d of l)o.h(d),d.startTime<r.firstHiddenTime&&(i.value=Math.max(d.startTime-f(),0),i.entries=[d],e())},s=v("largest-contentful-paint",a);if(s){e=u(n,i,W,t.reportAllChanges);const l=M((()=>{a(s.takeRecords()),s.disconnect(),e(!0)})),d=p=>{p.isTrusted&&(x(l),removeEventListener(p.type,d,{capture:!0}))};for(const p of["keydown","click","visibilitychange"])addEventListener(p,d,{capture:!0});m((p=>{i=c("LCP"),e=u(n,i,W,t.reportAllChanges),L((()=>{i.value=performance.now()-p.timeStamp,e(!0)}))}))}}))},B=[800,1800],A=n=>{document.prerendering?b((()=>A(n))):document.readyState!=="complete"?addEventListener("load",(()=>A(n)),!0):setTimeout(n)},X=(n,t={})=>{let r=c("TTFB"),e=u(n,r,B,t.reportAllChanges);A((()=>{const i=I();i&&(r.value=Math.max(i.responseStart-f(),0),r.entries=[i],e(!0),m((()=>{r=c("TTFB",0),e=u(n,r,B,t.reportAllChanges),e(!0)})))}))};class Y{constructor(t={}){this.options={endpoint:"/api/web-vitals",debug:!1,thresholds:{LCP:2500,FID:100,CLS:.1,FCP:1800,TTFB:600},...t},this.vitals={},this.analytics=this.initAnalytics()}initAnalytics(){return typeof window<"u"&&typeof window.gtag=="function"?{send:(t,r,e)=>{window.gtag("event",t,{event_category:"Web Vitals",value:Math.round(r),custom_map:{metric_rating:e.rating},non_interaction:!0})}}:null}getRating(t,r){const e={LCP:[2500,4e3],INP:[200,500],CLS:[.1,.25],FCP:[1800,3e3],TTFB:[800,1800]},[i,o]=e[t]||[0,0];return r<=i?"good":r<=o?"needs-improvement":"poor"}async sendToAnalytics(t){const{name:r,value:e,rating:i,delta:o,id:a}=t;if(this.vitals[r]={value:e,rating:i,delta:o,id:a,timestamp:Date.now()},this.options.debug&&console.log(`[Web Vitals] ${r}:`,{value:Math.round(e),rating:i,delta:Math.round(o),threshold:this.options.thresholds[r]}),this.analytics&&this.analytics.send(`web_vital_${r.toLowerCase()}`,e,{rating:i}),this.options.endpoint&&typeof this.options.endpoint=="string"&&this.options.endpoint.length>0){if(this.options.debug&&!this.options.forceEndpoint){this.options.debug&&console.log(`[Web Vitals] Skipping endpoint in dev mode: ${this.options.endpoint}`);return}try{await fetch(this.options.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({metric:r,value:Math.round(e),rating:i,delta:Math.round(o),id:a,url:window.location.pathname,timestamp:Date.now(),userAgent:navigator.userAgent,connection:navigator.connection?.effectiveType||"unknown"})})}catch(s){this.options.debug&&console.warn("[Web Vitals] Failed to send metric to",this.options.endpoint,":",s.message)}}}init(){j(t=>{t.rating=this.getRating("CLS",t.value),this.sendToAnalytics(t)}),_(t=>{t.rating=this.getRating("FCP",t.value),this.sendToAnalytics(t)}),U(t=>{t.rating=this.getRating("LCP",t.value),this.sendToAnalytics(t)}),X(t=>{t.rating=this.getRating("TTFB",t.value),this.sendToAnalytics(t)}),K(t=>{t.rating=this.getRating("INP",t.value),this.sendToAnalytics(t)})}initCustomINP(){if("PerformanceObserver"in window)try{new PerformanceObserver(r=>{for(const e of r.getEntries())if(e.interactionId){const i={name:"INP",value:e.processingStart-e.startTime,rating:this.getRating("INP",e.processingStart-e.startTime),delta:e.processingStart-e.startTime,id:`inp-${Date.now()}-${Math.random()}`,entries:[e]};this.sendToAnalytics(i)}}).observe({type:"event",buffered:!0,durationThreshold:40})}catch(t){this.options.debug&&console.warn("[Web Vitals] INP monitoring not supported:",t)}}getSummary(){return{vitals:this.vitals,timestamp:Date.now(),url:window.location.pathname,userAgent:navigator.userAgent}}reportIssues(){this.options.debug&&Object.entries(this.vitals).forEach(([t,r])=>{const e=this.options.thresholds[t];e&&r.value>e&&console.warn(`[Performance Issue] ${t} is ${r.rating} (${Math.round(r.value)} > ${e})`)})}}let h;function Z(n={}){return h||(h=new Y(n),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>h.init()):h.init(),n.debug&&window.addEventListener("load",()=>{setTimeout(()=>h.reportIssues(),3e3)}),h)}function tt(){return h?h.getSummary():null}export{Y as default,tt as getWebVitalsSummary,Z as initWebVitals};
